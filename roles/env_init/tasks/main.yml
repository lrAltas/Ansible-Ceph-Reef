# SPDX-License-Identifier: MIT-0
---
# tasks file for roles/env_init
# you don't need to config the mark directory,use the default value
# mark_dir_path: "~/.ansible_task_mark"
- name: Ensure mark directory exists
  ansible.builtin.file:
    path: "{{ mark_dir_path }}"
    state: directory
    mode: '0755'

- name: Configure hosts file and host name
  block:
    - name: Configure /etc/hosts file
      ansible.builtin.template:
        src: hosts.j2
        dest: /etc/hosts
        mode: '0644'

    - name: Set hostname
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"

- name: Upgrade all packages and install necessary tool packages
  block:
    - name: Upgrade all packages
      ansible.builtin.dnf:
        name: "*"
        state: present

    - name: Install necessary tool packages
      ansible.builtin.dnf:
        name: "{{ necessary_tool_packages }}"
        state: present
        update_cache: true

    - name: Import Storage SIG GPG key
      ansible.builtin.rpm_key:
        state: present
        key: https://www.centos.org/keys/RPM-GPG-KEY-CentOS-SIG-Storage

    - name: Install ceph-release package
      ansible.builtin.dnf:
        name: "{{ ceph_release_package }}"
        state: present
        update_cache: true

    - name: Install Ceph packages
      ansible.builtin.dnf:
        name: "{{ ceph_packages }}"
        state: present

- name: Configure SElinux and firewalld
  block:
    - name: Configure SElinux to permissive mode pemenently
      ansible.posix.selinux:
        policy: targeted
        state: disabled

    - name: Set SELinux to permissive mode if enforcing
      ansible.posix.selinux:
        policy: targeted
        state: permissive
      when: ansible_selinux.status == "Enforcing"

    - name: Stop and disable firewalld
      ansible.builtin.service:
        name: firewalld
        state: stopped
        enabled: false
      failed_when: false

- name: Configure NTP service
  block:
    - name: Install Chrony
      ansible.builtin.dnf:
        name: chrony
        state: present

    - name: Configure chrony.conf
      ansible.builtin.template:
        src: chrony.conf.j2
        dest: /etc/chrony.conf
        mode: '0644'

    - name: Enable and Start Chronyd Service
      ansible.builtin.service:
        name: chronyd
        state: started
        enabled: true

    - name: Enable set_ntp_yes in timedatectl
      ansible.builtin.command: timedatectl set-ntp yes

    - name: Print current time status
      ansible.builtin.command: timedatectl status
      register: env_init_timedatectl_status
      changed_when: false

    - name: Show current time status
      ansible.builtin.debug:
        var: env_init_timedatectl_status.stdout_lines
